#
# Makefile for testing the guido engine
#
# Checking the engine output
#   the principle is the following:
#   an image target generates image files using guido2image for a large set of gmn files
#   the validate target makes the comparison of files generated by different versions
#
# Checking memory leaks
#   requires valgrind
#
# Precondition for windows : guidogetversion.exe and GUIDOEngine.dll have to be copied in validate folder

version	:= $(shell guidogetversion | cut -d' ' -f 3)
system	:= $(shell uname -s)
LEAKTOOLS = guidoparse guidoar2gr guidodraw


guido2image := guido2image
guido2svg   := guido2svg
guido2midi  := guido2midi
guido2proll := guido2proll

ifeq ($(system), Darwin)
  lib =  -F../build/MacOS/Release/ -framework GUIDOEngine
else
ifeq ($(system), MINGW32_NT-6.1)
  libbin  := ../build/win32/Release
  toolbin := ../src/tools/build/win32/Release
  lib       = $(libbin)/GUIDOEngine.lib
  LEAKTOOLS = GUIDOEngine.dll guidogetversion.exe guido2svg.exe guidoparse.exe guidoar2gr.exe guidodraw.exe guido2image.exe guidogetstaffmap.exe guidogetsystemmap.exe guidogettimemap.exe guidogetvoicemap.exe guido2midi.exe guido2proll.exe
else
  lib = -lGUIDOEngine
endif
endif

ifdef TOOL
	TOOLPATH := $(shell basename $(TOOL))
endif

nodlost	= "definitely lost: 0"
noilost	= "indirectly lost: 0"
noplost	= "possibly lost: 0"

gmnfiles      = $(shell find ../gmn-examples -name "*.gmn") $(shell find ../regression-tests -name "*.gmn")
gmnfilesproll = $(shell find ../regression-tests/pianoroll -name "*.gmn")

pdfout		:= $(patsubst ../%.gmn, $(version)/%.pdf, $(gmnfiles))
svgout		:= $(patsubst ../%.gmn, $(version)/standard/%.svg, $(gmnfiles))

sysmapout	:= $(patsubst ../%.gmn, $(version)/maps/system/%.svg, $(gmnfiles))
staffmapout	:= $(patsubst ../%.gmn, $(version)/maps/staff/%.svg, $(gmnfiles))
voicemapout	:= $(patsubst ../%.gmn, $(version)/maps/voice/%.svg, $(gmnfiles))
mapsout		:= $(sysmapout) $(staffmapout) $(voicemapout)
timemapout	:= $(patsubst ../%.gmn, $(version)/maps/time/%.map, $(gmnfiles))

prollout	            := $(patsubst ../%.gmn, $(version)/proll/classic/standard/%.svg, $(gmnfilesproll))
prollvoicescolorout     := $(patsubst ../%.gmn, $(version)/proll/classic/voicescolor/%.svg, $(gmnfilesproll))
prolltrajout            := $(patsubst ../%.gmn, $(version)/proll/trajectory/standard/%.svg, $(gmnfilesproll))
prollvoicescolortrajout := $(patsubst ../%.gmn, $(version)/proll/trajectory/voicescolor/%.svg, $(gmnfilesproll))

leaksout 	:= $(patsubst ../%.gmn, $(version)/$(TOOLPATH)/%.leaks.txt, $(gmnfiles))
midiout     := $(patsubst ../%.gmn, $(version)/%.mid, $(gmnfiles))


allpdf 		 = $(shell [ -d $(version) ] && find $(version) -name "*.pdf")
allsvg 		 = $(shell [ -d $(version) ] && find $(version)/standard -name "*.svg")
allmap 		 = $(shell [ -d $(version) ] && find $(version)/maps -name "*.svg")
alltimemap 	 = $(shell [ -d $(version) ] && find $(version)/maps/time -name "*.map")
allproll 	 = $(shell [ -d $(version) ] && find $(version)/proll -name "*.svg")
leaksfiles  := $(patsubst ../%.gmn, $(version)/$(TOOLPATH)/%.leaks.out, $(gmnfiles))

validpdf 	    = $(patsubst %.pdf, %.outpdf, $(allpdf))
validsvg 	    = $(patsubst %.svg, %.outsvg, $(allsvg))
validsvgwin     = $(patsubst %.svg, %.outsvgwin, $(allsvg))
validmap 	    = $(patsubst %.svg, %.outsvg, $(allmap))
validmapwin     = $(patsubst %.svg, %.outsvgwin, $(allmap))
validtimemap    = $(patsubst %.map, %.outtimemap, $(alltimemap))
validtimemapwin = $(patsubst %.map, %.outtimemapwin, $(alltimemap))
validproll      = $(patsubst %.svg, %.outsvg, $(allproll))
validprollwin   = $(patsubst %.svg, %.outsvgwin, $(allproll))

.PHONY: pdf svg

default : svg

help:
	@echo "Makefile for testing the engine output. Available targets are:"
	@echo "'svg' (default): makes svg files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'pdf'          : makes pdf files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'midi'         : makes MIDI files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'validate    VERSION=another_version': compares the current version svg output with another one"
	@echo "'validateWin VERSION=another_version': compares on Windows the current version svg output with another one (Firefox has to be installed (and opened) in C:/Program Files (x86)/Mozilla Firefox/firefox, if not change Makefile)"
	@echo "'pdfvalidate VERSION=another_version': compares the current version pdf output with another one"
	@echo "'checkleaks TOOL=a_tool': check memory leaks on a set of gmn files using various tools"
	@echo "                 the basic tool set is included in this folder but any tool arbitrary tool could be used as well"
	@echo "'checkcrash TOOL=a_tool': run a tool with all the gmn files as arguments"
	@echo "--------------------------------"
	@echo "'svgclean'  : removes svg output"
	@echo "'pdfclean'  : removes pdf output"
	@echo "'midiclean' : removes midi files output"
	@echo "--------------------------------"
	@echo "'tools'     : build the tools"
	@echo "'win32'     : copy the tools and dll to the validate folder"

#########################################################################
# tools to validate the graphic output, based on pdf conversion
validate: $(validsvg)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)
	make validmap
	make validtimemap
	make validproll

validmap: $(validmap)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating maps version $(version) with $(VERSION) $(tmp)

validtimemap: $(validtimemap)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating time maps version $(version) with $(VERSION) $(tmp)

validproll: $(validproll)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating proll version $(version) with $(VERSION) $(tmp)
	
validateWin: $(validsvgwin)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)
	make validmapWin
	make validtimemapWin
	make validprollWin

validmapWin: $(validmapwin)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating maps version $(version) with $(VERSION) $(tmp)

validtimemapWin: $(validtimemapwin)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating time maps version $(version) with $(VERSION) $(tmp)

validprollWin: $(validprollwin)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating proll version $(version) with $(VERSION) $(tmp)

pdfvalidate: $(validpdf)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)
	make validmap
	
#########################################################################
# rules
%.outsvg: %.svg
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open -t $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)
		
%.outtimemap: %.map
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open -t $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)

%.outsvgwin: %.svg
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && C:/Program\ Files\ \(x86\)/Mozilla\ Firefox/firefox -new-tab $(patsubst $(version)/%, $(VERSION)/%, $<) -new-tab $<; true)
			
%.outtimemapwin: %.map
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo $< : differences found)

%.outpdf: %.pdf
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)

#########################################################################
# pdf output generation
pdf: forcepdfdate $(pdfout) $(mapsout)
	@./forcepdfdate 20100101120000 $(pdfout)

pdfclean: 
	rm -f $(pdfout)

$(version)/%.pdf: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(guido2image) -b  off -f $< -o $@

#########################################################################
# midi output generation
midi:  $(midiout)

midiclean: 
	rm -f $(midiout)

$(version)/%.mid: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2midi) $< -o $@


#########################################################################
# leaks check tools
checkleaks: $(LEAKTOOLS) $(leaksout)
	make showleaks TOOL=$(TOOL)

showleaks: $(leaksfiles)

$(version)/$(TOOLPATH)/%.leaks.txt: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	valgrind --leak-check=full --suppressions=valgrindignored.txt --log-file=$@ $(TOOL) $<

$(version)/$(TOOLPATH)/%.leaks.out: $(version)/$(TOOLPATH)/%.leaks.txt	
	@grep $(nodlost) $< > /dev/null || echo "$< : definitely lost bytes"
	@grep $(noilost) $< > /dev/null || echo "$< : indirectly lost bytes"
	@grep $(noplost) $< > /dev/null || echo "$< : possibly lost bytes"


#########################################################################
# crash tests
checkcrash: $(LEAKTOOLS)
	@$(TOOL) $(gmnfiles)


#########################################################################
# tools to generate svg files
svg: $(svgout) $(mapsout) $(timemapout) $(prollout) $(prollvoicescolorout) $(prolltrajout) $(prollvoicescolortrajout)

svgclean: 
	rm -f $(svgout)

$(version)/standard/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2svg) $< | grep -v "SVG file generated using" > __tmp.svg  &&  mv __tmp.svg $@


#########################################################################
# tools to generate map files
map: $(mapsout)

$(version)/maps/system/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2svg) -systemmap true $<  > $@

$(version)/maps/staff/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2svg) -staffmap true $<  > $@

$(version)/maps/voice/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2svg) -voicemap true $<  > $@

	
timemap: $(timemapout)
$(version)/maps/time/%.map: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-guidogettimemap $< > $@

	
#########################################################################
# tools to generate proll files
proll: $(prollout) $(prollvoicescolorout) $(prolltrajout) $(prollvoicescolortrajout)
$(version)/proll/classic/standard/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2proll) $< > $@
    
$(version)/proll/classic/voicescolor%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2proll) -voicesautocolor true $< > $@
    
$(version)/proll/trajectory/standard/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2proll) -pianoroll trajectory $< > $@
    
$(version)/proll/trajectory/voicescolor%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2proll) -pianoroll trajectory -voicesautocolor true $< > $@


#########################################################################
# windows specific stuff
win32: $(LEAKTOOLS)

GUIDOEngine.dll:
	cp $(libbin)/GUIDOEngine.dll .

guidogetversion.exe:
	cp $(toolbin)/guidogetversion.exe .

guido2svg.exe:
	cp $(toolbin)/guido2svg.exe .

guido2midi.exe:
	cp $(toolbin)/guido2midi.exe .

guidoparse.exe:
	cp $(toolbin)/guidoparse.exe .

guidoar2gr.exe:
	cp $(toolbin)/guidoar2gr.exe .

guidodraw.exe:
	cp $(toolbin)/guidodraw.exe .

guidogetstaffmap.exe:
	cp $(toolbin)/guidogetstaffmap.exe .

guidogetsystemmap.exe:
	cp $(toolbin)/guidogetsystemmap.exe .

guidogettimemap.exe:
	cp $(toolbin)/guidogettimemap.exe .

guidogetvoicemap.exe:
	cp $(toolbin)/guidogetvoicemap.exe .

guido2proll.exe:
	cp $(toolbin)/guido2proll.exe .

guido2image.exe:
	cp ../environments/Qt/bin/guido2image.exe .

#########################################################################
# tools
tools: $(LEAKTOOLS)

cleantools:
	rm -f $(LEAKTOOLS)

guidodraw : guidodraw.cpp
	g++ guidodraw.cpp -I../src/include -I../src/tools $(lib) -o guidodraw

guidoar2gr : guidoar2gr.cpp
	g++ guidoar2gr.cpp -I../src/include -I../src/tools $(lib) -o guidoar2gr

guidoparse : guidoparse.cpp
	g++ guidoparse.cpp -I../src/include $(lib) -o guidoparse

forcepdfdate: forcepdfdate.cpp
	g++ forcepdfdate.cpp -o forcepdfdate

